<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CryptoVision - AI bot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Общие стили для темной темы, вдохновленные TradingView */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1A202C; /* Темный сине-серый фон */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Выравнивание по верху */
            min-height: 100vh;
            padding: 1rem;
            box-sizing: border-box;
            color: #E2E8F0; /* Светлый текст */
        }
        .container {
            background-color: #2D3748; /* Чуть светлее темный фон для контейнера */
            border-radius: 1rem; /* Скругленные углы */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            padding: 1.5rem;
            width: 100%;
            max-width: 500px; /* Максимальная ширина для лучшей читаемости */
            box-sizing: border-box;
            min-height: 70vh; /* Минимальная высота для лучшего отображения */
            display: flex;
            flex-direction: column;
        }
        .page {
            display: none;
            flex-grow: 1; /* Позволяет странице занимать доступное пространство */
            padding-top: 1rem;
            padding-bottom: 1rem;
        }
        .page.active {
            display: flex;
            flex-direction: column;
        }
        .btn-primary {
            background-image: linear-gradient(to right, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem; /* Более скругленные */
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            border: none;
            outline: none;
        }
        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.25);
        }
        .btn-secondary {
            background-color: #4A5568;
            color: #E2E8F0;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
            outline: none;
        }
        .btn-secondary:hover {
            background-color: #64748B;
        }
        .loading-spinner {
            border: 4px solid #4A5568; /* Цвет спиннера под темную тему */
            border-top: 4px solid #63B3ED; /* Акцентный цвет спиннера */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 1rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Обновленные стили для карточек анализа */
        .card {
            background-color: #2C3440; /* Темнее фон для карточек */
            border-radius: 1rem; /* Более скругленные углы */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            padding: 1.5rem; /* Увеличенный отступ */
            margin-top: 1rem; /* Отступ сверху */
            border: none; /* Убираем рамку */
        }
        .analysis-item span:first-child {
            font-weight: 600;
            color: #90CDF4; /* Светло-голубой для заголовков */
        }
        .image-upload-area {
            border: 2px dashed #4A5568;
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 1rem;
        }
        .image-upload-area:hover {
            border-color: #63B3ED;
            background-color: #374151;
        }
        .image-preview {
            max-width: 100%;
            border-radius: 0.5rem;
            margin-top: 1rem;
            display: none; /* Скрыто по умолчанию */
            border: 1px solid #4A5568;
        }
        .subscription-plan {
            background-color: #374151; /* Темнее фон для планов подписки */
            border: 1px solid #4A5568;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .subscription-plan h3 {
            font-weight: 700;
            color: #E2E8F0;
            margin-bottom: 0.5rem;
        }
        .subscription-plan p {
            color: #CBD5E1;
            font-size: 0.9rem;
        }
        .payment-info {
            text-align: center;
            padding: 1rem;
            color: #CBD5E1;
        }
        .payment-info img {
            max-width: 80px;
            margin: 0 auto 1rem;
        }
        .text-green-600 { color: #68D391; } /* Зеленый для темной темы */
        .text-red-600 { color: #FC8181; } /* Красный для темной темы */
        .text-blue-600 { color: #63B3ED; } /* Голубой для темной темы */

        /* Стили для нового дизайна "Анализ" */
        .analysis-section-card {
            background-color: #2C3440; /* Темнее фон для отдельных секций анализа */
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1rem; /* Отступ между секциями */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .analysis-section-card h2 {
            font-size: 1.25rem; /* Больше заголовок */
            font-weight: 700;
            color: #E2E8F0;
            margin-bottom: 1rem;
            text-align: center;
        }
        .key-insight-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        .insight-item {
            background-color: #374151; /* Фон для отдельных инсайтов */
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            color: #CBD5E1;
            font-size: 0.9rem;
        }
        .insight-item .icon {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: #63B3ED; /* Акцентный цвет для иконок */
        }
        .insight-item .value {
            font-weight: 600;
            color: #E2E8F0;
            margin-top: 0.25rem;
        }
        .game-plan-text {
            color: #CBD5E1;
            line-height: 1.6;
            font-size: 0.95rem;
        }
        .detailed-analysis-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .detailed-analysis-list li {
            background-color: #374151;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.95rem;
            color: #E2E8F0;
        }
        .detailed-analysis-list li .number {
            background-color: #6a11cb; /* Цвет кружка с номером */
            color: white;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.85rem;
            margin-right: 0.75rem;
            flex-shrink: 0;
        }
        .detailed-analysis-list li .lock-icon {
            margin-left: 0.75rem;
            color: #9CA3AF; /* Серый цвет для иконки замка */
            font-size: 1.2rem;
            flex-shrink: 0;
        }
        .detailed-analysis-list li .text-content {
            flex-grow: 1;
        }
        .feature-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
            color: #CBD5E1;
            font-size: 1rem;
        }
        .feature-item .icon {
            font-size: 1.2rem;
            margin-right: 0.75rem;
        }
        .feature-item.available .icon {
            color: #68D391; /* Зеленый для доступных */
        }
        .feature-item.unavailable {
            color: #718096; /* Серый для недоступных */
        }
        .feature-item.unavailable .icon {
            color: #E53E3E; /* Красный для недоступных */
        }
        .locked-content {
            filter: blur(2px); /* Размытие для заблокированного контента */
            pointer-events: none; /* Отключаем взаимодействие */
            user-select: none; /* Отключаем выделение текста */
        }
        .lock-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            border-radius: 1rem;
            z-index: 10;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Welcome Page -->
        <div id="welcomePage" class="page active">
            <h1 class="text-2xl font-bold text-center mb-6">CryptoVision - AI бот</h1>
            <img src="https://placehold.co/150x150/2C3440/63B3ED?text=AI+Bot" alt="Логотип CryptoVision AI Bot" class="mx-auto mb-6 rounded-full shadow-lg">

            <p class="text-center text-gray-300 mb-6">
                Добро пожаловать в CryptoVision AI Bot! Мы предоставляем передовой анализ криптовалютных графиков на основе искусственного интеллекта.
            </p>

            <div class="card mb-6">
                <h2 class="text-xl font-semibold text-center mb-4">Наши возможности:</h2>
                <div class="space-y-3">
                    <div class="feature-item available">
                        <span class="icon">✅</span>
                        <span>AI-анализ графиков (базовый)</span>
                    </div>
                    <div class="feature-item available">
                        <span class="icon">✅</span>
                        <span>Торговые сигналы (базовые)</span>
                    </div>
                    <div class="feature-item unavailable">
                        <span class="icon">❌</span>
                        <span>Детальный технический анализ</span>
                        <span class="ml-auto text-gray-500">🔒</span>
                    </div>
                    <div class="feature-item unavailable">
                        <span class="icon">❌</span>
                        <span>Новостной анализ</span>
                        <span class="ml-auto text-gray-500">🔒</span>
                    </div>
                    <div class="feature-item unavailable">
                        <span class="icon">❌</span>
                        <span>Персональные консультации</span>
                        <span class="ml-auto text-gray-500">🔒</span>
                    </div>
                </div>
            </div>
            <button class="btn-primary w-full mt-auto" onclick="showPage('analysisPage')">Далее</button>
        </div>

        <!-- Analysis Page -->
        <div id="analysisPage" class="page">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">AI Анализ Графика</h2>
                <button class="btn-secondary px-4 py-2" onclick="showInstructionModal()">Инструкция</button>
            </div>

            <div class="analysis-section-card mb-4">
                <label for="chartImageUpload" class="block text-sm font-medium mb-2 text-gray-300">Загрузите изображение графика:</label>
                <div class="image-upload-area" id="imageUploadArea">
                    <input type="file" id="chartImageUpload" accept="image/*" class="hidden">
                    <p class="text-gray-400">Нажмите или перетащите файл сюда</p>
                    <img id="imagePreview" class="image-preview mx-auto" src="#" alt="Предварительный просмотр графика">
                </div>
            </div>

            <button id="getAnalysisBtn" class="btn-primary w-full flex items-center justify-center mb-6">
                <span id="buttonText">Получить анализ</span>
                <div id="loadingSpinner" class="loading-spinner hidden ml-3"></div>
            </button>

            <div id="analysisResult" class="hidden">
                <h2 class="text-xl font-bold text-center mb-4">Ваш индивидуальный AI анализ графика:</h2>

                <!-- Key Insights Section -->
                <div class="analysis-section-card">
                    <h2>Ключевые Инсайты</h2>
                    <div class="key-insight-grid mb-4">
                        <div class="insight-item">
                            <span class="icon">📈</span>
                            <span>Тренд</span>
                            <span class="value" id="outputTrend">Бычий</span>
                        </div>
                        <div class="insight-item">
                            <span class="icon">📊</span>
                            <span>Волатильность</span>
                            <span class="value" id="outputVolatility">Средняя</span>
                        </div>
                        <div class="insight-item">
                            <span>Объем</span>
                            <span class="value" id="outputVolume">Высокий</span>
                        </div>
                        <div class="insight-item">
                            <span>Настроение рынка</span>
                            <span class="value" id="outputSentiment">Нейтральное</span>
                        </div>
                    </div>
                    <div class="space-y-2 text-gray-300">
                        <p class="analysis-item"><span class="text-blue-600">Действие:</span> <span id="outputAction" class="font-bold"></span></p>
                        <p class="analysis-item"><span class="text-blue-600">Цена входа:</span> <span id="outputEntryPrice"></span></p>
                        <p class="analysis-item"><span class="text-blue-600">Целевая цена:</span> <span id="outputTargetPrice"></span></p>
                        <p class="analysis-item"><span class="text-blue-600">Стоп-лосс:</span> <span id="outputStopLoss"></span></p>
                        <p class="analysis-item"><span class="text-blue-600">Тейк-профит:</span> <span id="outputTakeProfit"></span></p>
                    </div>
                </div>

                <!-- Game Plan Section -->
                <div class="analysis-section-card">
                    <h2>План Действий</h2>
                    <p class="game-plan-text" id="outputGamePlan">
                        Биткойн в настоящее время торгуется около $98,218 и демонстрирует сильный бычий импульс с высоким объемом, что указывает на растущий интерес. Мой торговый план состоит в том, чтобы войти в длинную позицию около $97,500, установить стоп-лосс чуть ниже недавней поддержки на уровне $95,000 и стремиться к цели в $105,000, что соответствует предыдущим уровням сопротивления. (демо)
                    </p>
                </div>

                <!-- Detailed Analysis Section (Locked for basic plan) -->
                <div class="analysis-section-card relative">
                    <h2>Детальный Анализ</h2>
                    <ul class="detailed-analysis-list locked-content">
                        <li>
                            <span class="number">1</span>
                            <span class="text-content" id="detailedAnalysis1">Внутридневная волатильность</span>
                            <span class="lock-icon">🔒</span>
                        </li>
                        <li>
                            <span class="number">2</span>
                            <span class="text-content" id="detailedAnalysis2">Всплески объема во время разворотов</span>
                            <span class="lock-icon">🔒</span>
                        </li>
                        <li>
                            <span class="number">3</span>
                            <span class="text-content" id="detailedAnalysis3">Отсутствие всеобъемлющего тренда</span>
                            <span class="lock-icon">🔒</span>
                        </li>
                        <li>
                            <span class="number">4</span>
                            <span class="text-content" id="detailedAnalysis4">Доминирование разворотных свечей</span>
                            <span class="lock-icon">🔒</span>
                        </li>
                        <li>
                            <span class="number">5</span>
                            <span class="text-content" id="detailedAnalysis5">Поддержка и сопротивление</span>
                            <span class="lock-icon">🔒</span>
                        </li>
                    </ul>
                    <div class="lock-overlay" id="detailedAnalysisLockOverlay">
                        <span class="text-2xl">Доступно в Премиум плане 🔒</span>
                    </div>
                </div>
            </div>

            <div id="errorMessage" class="hidden bg-red-800 border border-red-600 text-red-200 px-4 py-3 rounded-md mt-4" role="alert">
                <strong class="font-bold">Ошибка!</strong>
                <span class="block sm:inline" id="errorText"></span>
            </div>

            <button class="btn-primary w-full mt-auto" onclick="showPage('subscriptionPage')">Сменить план</button>
        </div>

        <!-- Subscription Page -->
        <div id="subscriptionPage" class="page">
            <h2 class="text-xl font-semibold text-center mb-4">Наши Подписки</h2>
            <div class="subscription-plan">
                <h3>Базовый план</h3>
                <p>Доступ к базовому анализу.</p>
                <p class="font-bold text-lg mt-2">Бесплатно</p>
            </div>
            <div class="subscription-plan">
                <h3>Премиум план</h3>
                <p>Полный доступ к AI-анализу, расширенным инструментам и эксклюзивным сигналам.</p>
                <p class="font-bold text-lg mt-2">9.99 Stars/месяц</p>
                <button class="btn-primary w-full mt-3" onclick="requestSubscriptionPayment(999)">Подписаться</button>
            </div>
            <div class="subscription-plan">
                <h3>VIP план</h3>
                <p>Все возможности Премиум плана плюс персональные консультации и ранний доступ к новым функциям.</p>
                <p class="font-bold text-lg mt-2">29.99 Stars/месяц</p>
                <button class="btn-primary w-full mt-3" onclick="requestSubscriptionPayment(2999)">Подписаться</button>
            </div>
            <button class="btn-secondary w-full mt-auto" onclick="showPage('analysisPage')">Назад к Анализу</button>
        </div>

        <!-- Payment Page -->
        <div id="paymentPage" class="page">
            <h2 class="text-xl font-semibold text-center mb-4">Пополнение Баланса</h2>
            <div class="payment-info">
                <img src="https://placehold.co/80x80/0088CC/FFFFFF?text=%E2%AD%90" alt="Telegram Stars Icon" class="mx-auto mb-4">
                <p class="mb-4">Для пополнения баланса и активации подписок мы используем Telegram Stars.</p>
                <p class="mb-4">Ваш текущий баланс: <span class="font-bold text-blue-600" id="userStarsBalance">0 Stars</span></p>
                <button id="addStarsBtn" class="btn-primary w-full">Пополнить через Telegram Stars (100 Stars)</button>
                <p class="text-sm text-gray-400 mt-4">Нажмите кнопку выше, чтобы открыть интерфейс покупки Telegram Stars.</p>
            </div>
            <button class="btn-secondary w-full mt-auto" onclick="showPage('subscriptionPage')">Назад к Подпискам</button>
        </div>

        <!-- Instruction Modal -->
        <div id="instructionModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden">
            <div class="bg-gray-800 rounded-lg p-6 max-w-sm w-full relative">
                <h2 class="text-xl font-bold text-white mb-4 text-center">Инструкция</h2>
                <p class="text-gray-300 mb-4">
                    1. Загрузите скриншот графика, который вы хотите проанализировать.<br>
                    2. Нажмите "Получить анализ".<br>
                    3. AI предоставит вам ключевые инсайты и план действий.<br>
                    4. Для детального анализа и расширенных функций рассмотрите Премиум или VIP план.
                </p>
                <button class="btn-primary w-full" onclick="hideInstructionModal()">Понятно</button>
            </div>
        </div>

    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        // Получаем ссылки на элементы DOM
        const chartImageUpload = document.getElementById('chartImageUpload');
        const imageUploadArea = document.getElementById('imageUploadArea');
        const imagePreview = document.getElementById('imagePreview');
        const getAnalysisBtn = document.getElementById('getAnalysisBtn');
        const buttonText = document.getElementById('buttonText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const analysisResult = document.getElementById('analysisResult');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');

        // Элементы вывода анализа
        const outputAction = document.getElementById('outputAction');
        const outputEntryPrice = document.getElementById('outputEntryPrice');
        const outputTargetPrice = document.getElementById('outputTargetPrice');
        const outputStopLoss = document.getElementById('outputStopLoss');
        const outputTakeProfit = document.getElementById('outputTakeProfit');
        const outputTrend = document.getElementById('outputTrend');
        const outputVolatility = document.getElementById('outputVolatility');
        const outputVolume = document.getElementById('outputVolume');
        const outputSentiment = document.getElementById('outputSentiment');
        const outputGamePlan = document.getElementById('outputGamePlan');
        const detailedAnalysis1 = document.getElementById('detailedAnalysis1');
        const detailedAnalysis2 = document.getElementById('detailedAnalysis2');
        const detailedAnalysis3 = document.getElementById('detailedAnalysis3');
        const detailedAnalysis4 = document.getElementById('detailedAnalysis4');
        const detailedAnalysis5 = document.getElementById('detailedAnalysis5');
        const detailedAnalysisLockOverlay = document.getElementById('detailedAnalysisLockOverlay');


        // Элементы страниц
        const welcomePage = document.getElementById('welcomePage');
        const analysisPage = document.getElementById('analysisPage');
        const subscriptionPage = document.getElementById('subscriptionPage');
        const paymentPage = document.getElementById('paymentPage');
        const instructionModal = document.getElementById('instructionModal');


        // Кнопки пополнения Stars и баланс
        const addStarsBtn = document.getElementById('addStarsBtn');
        const userStarsBalance = document.getElementById('userStarsBalance');

        let uploadedImageBase64 = null; // Для хранения base64 изображения

        // Инициализация Telegram Web App
        if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand(); // Разворачиваем мини-приложение на весь экран для лучшего UX
        } else {
            console.warn('Telegram Web App API not available. Running in standalone mode. Real payments will not work.');
        }

        // Функция для переключения страниц
        function showPage(pageId) {
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            // Прокручиваем страницу вверх при смене
            window.scrollTo(0, 0);
        }

        // Функция для показа модального окна инструкции
        function showInstructionModal() {
            instructionModal.classList.remove('hidden');
        }

        // Функция для скрытия модального окна инструкции
        function hideInstructionModal() {
            instructionModal.classList.add('hidden');
        }


        // Обработчик клика по области загрузки изображения
        imageUploadArea.addEventListener('click', () => {
            chartImageUpload.click();
        });

        // Обработчик изменения файла в input
        chartImageUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    imagePreview.style.display = 'block';
                    uploadedImageBase64 = e.target.result.split(',')[1]; // Сохраняем только base64 часть
                };
                reader.readAsDataURL(file);
            } else {
                imagePreview.src = '#';
                imagePreview.style.display = 'none';
                uploadedImageBase64 = null;
            }
        });

        // Обработчик события для кнопки анализа
        getAnalysisBtn.addEventListener('click', async () => {
            if (!uploadedImageBase64) {
                showErrorMessage('Пожалуйста, загрузите изображение графика для анализа.');
                return;
            }

            showLoading(true);
            hideErrorMessage();
            hideAnalysisResult();

            try {
                // Имитация задержки для демонстрации загрузки
                await new Promise(resolve => setTimeout(resolve, 2500)); // Увеличил задержку для лучшей демонстрации

                // Заглушка для функционала
                const dummyAnalysisData = {
                    action: Math.random() < 0.5 ? 'КУПИТЬ' : 'ПРОДАТЬ', // Случайное действие
                    entryPrice: '777',
                    targetPrice: '777',
                    stopLoss: '777',
                    takeProfit: '777',
                    trend: 'Бычий',
                    volatility: 'Средняя',
                    volume: 'Высокий',
                    sentiment: 'Нейтральное',
                    gamePlan: 'Биткойн в настоящее время торгуется около $98,218 и демонстрирует сильный бычий импульс с высоким объемом, что указывает на растущий интерес. Мой торговый план состоит в том, чтобы войти в длинную позицию около $97,500, установить стоп-лосс чуть ниже недавней поддержки на уровне $95,000 и стремиться к цели в $105,000, что соответствует предыдущим уровням сопротивления. (демо)',
                    detailedAnalysis: [
                        'Внутридневная волатильность',
                        'Всплески объема во время разворотов',
                        'Отсутствие всеобъемлющего тренда',
                        'Доминирование разворотных свечей',
                        'Поддержка и сопротивление'
                    ],
                    planLevel: 'basic' // 'basic', 'premium', 'vip' - для демонстрации блокировки
                };

                // Обновляем UI с заглушечными данными
                outputAction.textContent = dummyAnalysisData.action;
                outputEntryPrice.textContent = dummyAnalysisData.entryPrice;
                outputTargetPrice.textContent = dummyAnalysisData.targetPrice;
                outputStopLoss.textContent = dummyAnalysisData.stopLoss;
                outputTakeProfit.textContent = dummyAnalysisData.takeProfit;
                outputTrend.textContent = dummyAnalysisData.trend;
                outputVolatility.textContent = dummyAnalysisData.volatility;
                outputVolume.textContent = dummyAnalysisData.volume;
                outputSentiment.textContent = dummyAnalysisData.sentiment;
                outputGamePlan.textContent = dummyAnalysisData.gamePlan;
                detailedAnalysis1.textContent = dummyAnalysisData.detailedAnalysis[0];
                detailedAnalysis2.textContent = dummyAnalysisData.detailedAnalysis[1];
                detailedAnalysis3.textContent = dummyAnalysisData.detailedAnalysis[2];
                detailedAnalysis4.textContent = dummyAnalysisData.detailedAnalysis[3];
                detailedAnalysis5.textContent = dummyAnalysisData.detailedAnalysis[4];


                // Устанавливаем цвет для действия
                if (dummyAnalysisData.action === 'КУПИТЬ') {
                    outputAction.className = 'font-bold text-green-600';
                } else if (dummyAnalysisData.action === 'ПРОДАТЬ') {
                    outputAction.className = 'font-bold text-red-600';
                } else {
                    outputAction.className = 'font-bold text-gray-400';
                }

                // Управление блокировкой детального анализа
                if (dummyAnalysisData.planLevel === 'basic') {
                    detailedAnalysisLockOverlay.classList.remove('hidden');
                } else {
                    detailedAnalysisLockOverlay.classList.add('hidden');
                }

                showAnalysisResult();

                // В будущем здесь будет реальный вызов AI для анализа изображения:
                /*
                const prompt = "Проанализируйте этот график и предоставьте торговые рекомендации (КУПИТЬ/ПРОДАТЬ/ДЕРЖАТЬ), цену входа, целевую цену, стоп-лосс, тейк-профит, краткий технический анализ и краткий новостной анализ. Форматируйте ответ как JSON объект.";
                const chatHistory = [];
                const payload = {
                    contents: [
                        {
                            role: "user",
                            parts: [
                                { text: prompt },
                                {
                                    inlineData: {
                                        mimeType: "image/jpeg", // Или "image/png" в зависимости от загруженного
                                        data: uploadedImageBase64
                                    }
                                }
                            ]
                        }
                    ],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: { // Определите вашу схему здесь
                            type: "OBJECT",
                            properties: {
                                "action": { "type": "STRING" },
                                "entryPrice": { "type": "STRING" },
                                "targetPrice": { "type": "STRING" },
                                "stopLoss": { "type": "STRING" },
                                "takeProfit": { "type": "STRING" },
                                "technicalAnalysis": { "type": "STRING" },
                                "newsAnalysis": { "type": "STRING" }
                            }
                        }
                    }
                };

                const apiKey = ""; // API ключ будет предоставлен средой Canvas
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                // Обработка result и обновление UI
                */

            } catch (error) {
                console.error('Ошибка при получении анализа:', error);
                showErrorMessage('Произошла ошибка при получении анализа. Пожалуйста, проверьте ваше интернет-соединение или попробуйте позже.');
            } finally {
                showLoading(false);
            }
        });

        // Функция для запроса платежа Stars за подписку
        function requestSubscriptionPayment(starsAmount) {
            // В реальном приложении здесь будет логика для создания инвойса на сервере бота
            // и получения invoice_url или invoice_payload
            const invoicePayload = `subscription_plan_${starsAmount}`; // Пример payload

            if (Telegram.WebApp && Telegram.WebApp.requestPayment) {
                Telegram.WebApp.requestPayment({
                    amount: starsAmount, // Сумма в Stars (целые числа)
                    asset: 'stars', // Всегда 'stars' для Telegram Stars
                    payload: invoicePayload // Уникальный идентификатор для вашей транзакции
                }, (status) => {
                    if (status.status === 'succeeded') {
                        updateStarsBalance(starsAmount); // Демо-обновление баланса
                        Telegram.WebApp.showAlert(`Подписка на ${starsAmount / 100} Stars успешно оплачена!`);
                    } else {
                        Telegram.WebApp.showAlert(`Ошибка оплаты или отмена: ${status.status}`);
                    }
                });
            } else {
                console.warn(`Telegram Web App API not available. Cannot request payment for ${starsAmount / 100} Stars.`);
            }
        }

        // Обработчик для кнопки "Пополнить через Telegram Stars"
        addStarsBtn.addEventListener('click', () => {
            // В реальном приложении здесь будет логика для создания инвойса на сервере бота
            // и получения invoice_url или invoice_payload
            const starsToBuy = 100; // Пример: пользователь хочет купить 100 Stars
            const invoicePayload = `top_up_${starsToBuy}`; // Уникальный payload для пополнения

            if (Telegram.WebApp && Telegram.WebApp.requestPayment) {
                Telegram.WebApp.requestPayment({
                    amount: starsToBuy,
                    asset: 'stars',
                    payload: invoicePayload
                }, (status) => {
                    if (status.status === 'succeeded') {
                        updateStarsBalance(starsToBuy); // Демо-обновление баланса
                        Telegram.WebApp.showAlert(`Вы успешно пополнили баланс на ${starsToBuy} Stars!`);
                    } else {
                        Telegram.WebApp.showAlert(`Ошибка пополнения или отмена: ${status.status}`);
                    }
                });
            } else {
                console.warn(`Telegram Web App API not available. Cannot request payment for ${starsToBuy} Stars.`);
            }
        });

        // Демо-функция для обновления баланса Stars
        function updateStarsBalance(amount) {
            let currentBalance = parseFloat(userStarsBalance.textContent.replace(' Stars', ''));
            currentBalance += amount / 100; // Делим на 100, так как в UI отображаем 9.99, а в API целые числа
            userStarsBalance.textContent = `${currentBalance.toFixed(2)} Stars`;
        }

        // Функция для показа/скрытия спиннера загрузки
        function showLoading(isLoading) {
            if (isLoading) {
                buttonText.textContent = 'Загрузка...';
                loadingSpinner.classList.remove('hidden');
                getAnalysisBtn.disabled = true;
            } else {
                buttonText.textContent = 'Получить анализ';
                loadingSpinner.classList.add('hidden');
                getAnalysisBtn.disabled = false;
            }
        }

        // Функция для показа секции с результатами анализа
        function showAnalysisResult() {
            analysisResult.classList.remove('hidden');
        }

        // Функция для скрытия секции с результатами анализа
        function hideAnalysisResult() {
            analysisResult.classList.add('hidden');
        }

        // Функция для показа сообщения об ошибке
        function showErrorMessage(message) {
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        // Функция для скрытия сообщения об ошибке
        function hideErrorMessage() {
            errorMessage.classList.add('hidden');
        }

    </script>
</body>
</html>
