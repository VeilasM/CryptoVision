<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CryptoVision - AI bot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js для звуковых эффектов -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        /* Общие стили для темной темы, вдохновленные TradingView и логотипом */
        body {
            font-family: 'Inter', sans-serif;
            /* Более темный синий фон с легким градиентом */
            background: linear-gradient(to bottom, #000005, #05050A); /* Еще темнее */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Выравнивание по верху */
            min-height: 100vh;
            padding: 1rem;
            box-sizing: border-box;
            color: #E2E8F0; /* Светлый текст */
            position: relative; /* Для позиционирования нижней навигации */
            padding-bottom: 5rem; /* Отступ для нижней навигации */
        }
        .container {
            background-color: #0A0A14; /* Еще темнее синий фон для контейнера */
            border-radius: 1.5rem; /* Более скругленные углы */
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
            padding: 1.5rem;
            width: 100%;
            max-width: 500px; /* Максимальная ширина для лучшей читаемости */
            box-sizing: border-box;
            min-height: 70vh; /* Минимальная высота для лучшего отображения */
            display: flex;
            flex-direction: column;
            position: relative; /* Для внутренних элементов */
        }
        .page {
            display: none;
            flex-grow: 1; /* Позволяет странице занимать доступное пространство */
            padding-top: 1rem;
            padding-bottom: 1rem;
            animation: fadeIn 0.5s ease-out; /* Анимация появления страницы */
        }
        .page.active {
            display: flex;
            flex-direction: column;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .btn-primary {
            /* Сине-фиолетовый неоновый градиент */
            background-image: linear-gradient(to right, #3A00C0 0%, #00E0FF 100%); /* Более насыщенный сине-фиолетовый */
            color: white;
            padding: 0.85rem 1.75rem; /* Увеличенный padding */
            border-radius: 2rem; /* Круглая кнопка */
            font-weight: 700; /* Более жирный шрифт */
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 224, 255, 0.4); /* Неоновая тень */
            cursor: pointer;
            border: none;
            outline: none;
            text-transform: uppercase; /* Заглавные буквы */
            letter-spacing: 0.05em; /* Небольшой интервал между буквами */
        }
        .btn-primary:hover {
            opacity: 0.95;
            transform: translateY(-3px); /* Более выраженный подъем */
            box-shadow: 0 8px 20px rgba(0, 224, 255, 0.6);
        }
        .btn-secondary {
            background-color: #1A1A2E; /* Темно-синий */
            color: #E2E8F0;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
            outline: none;
        }
        .btn-secondary:hover {
            background-color: #2A2A3A;
        }
        .loading-spinner {
            border: 4px solid #3A3A4A; /* Цвет спиннера под темную тему */
            border-top: 4px solid #00FFFF; /* Неоновый синий акцент */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 1rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Обновленные стили для карточек анализа */
        .card {
            background-color: #1A1A2E; /* Темно-синий фон для карточек */
            border-radius: 1rem; /* Более скругленные углы */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            padding: 1.5rem; /* Увеличенный отступ */
            margin-top: 1rem; /* Отступ сверху */
            border: none; /* Убираем рамку */
        }
        .analysis-item span:first-child {
            font-weight: 600;
            color: #00FFFF; /* Неоновый синий для заголовков */
        }
        .image-upload-area {
            border: 2px dashed #2A2A3A; /* Синяя пунктирная рамка */
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 1rem;
        }
        .image-upload-area:hover {
            border-color: #FF00FF; /* Неоновый пурпурный при наведении */
            background-color: #1A1A2E;
        }
        .image-preview {
            max-width: 100%;
            border-radius: 0.5rem;
            margin-top: 1rem;
            display: none; /* Скрыто по умолчанию */
            border: 1px solid #2A2A3A;
        }
        .subscription-plan {
            background-color: #1A1A2E; /* Темно-синий фон для планов подписки */
            border: 1px solid #2A2A3A;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .subscription-plan h3 {
            font-weight: 700;
            color: #E2E8F0;
            margin-bottom: 0.5rem;
        }
        .subscription-plan p {
            color: #CBD5E1;
            font-size: 0.9rem;
        }
        .payment-info {
            text-align: center;
            padding: 1rem;
            color: #CBD5E1;
        }
        .payment-info img {
            max-width: 80px;
            margin: 0 auto 1rem;
        }
        .text-green-600 { color: #00FF00; } /* Неоновый зеленый */
        .text-red-600 { color: #FF0000; } /* Ярко-красный */
        .text-blue-600 { color: #00FFFF; } /* Неоновый синий */

        /* Стили для нового дизайна "Анализ" */
        .analysis-section-card {
            background-color: #1A1A2E; /* Темно-синий фон для отдельных секций анализа */
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1rem; /* Отступ между секциями */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .analysis-section-card h2 {
            font-size: 1.25rem; /* Больше заголовок */
            font-weight: 700;
            color: #E2E8F0;
            margin-bottom: 1rem;
            text-align: center;
        }
        .key-insight-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        .insight-item {
            background-color: #2A2A3A; /* Фон для отдельных инсайтов */
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            color: #CBD5E1;
            font-size: 0.9rem;
        }
        .insight-item .icon {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: #00FFFF; /* Неоновый синий акцент для иконок */
        }
        .insight-item .value {
            font-weight: 600;
            color: #E2E8F0;
            margin-top: 0.25rem;
        }
        .game-plan-text {
            color: #CBD5E1;
            line-height: 1.6;
            font-size: 0.95rem;
        }
        .detailed-analysis-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .detailed-analysis-list li {
            background-color: #2A2A3A;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.95rem;
            color: #E2E8F0;
        }
        .detailed-analysis-list li .number {
            background-color: #4A00E0; /* Темно-фиолетовый для кружка с номером */
            color: white;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.85rem;
            margin-right: 0.75rem;
            flex-shrink: 0;
        }
        .detailed-analysis-list li .lock-icon {
            margin-left: 0.75rem;
            color: #9CA3AF; /* Серый цвет для иконки замка */
            font-size: 1.2rem;
            flex-shrink: 0;
        }
        .detailed-analysis-list li .text-content {
            flex-grow: 1;
        }
        .feature-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
            color: #CBD5E1;
            font-size: 1rem;
        }
        .feature-item .icon {
            font-size: 1.2rem;
            margin-right: 0.75rem;
        }
        .feature-item.available .icon {
            color: #00FF00; /* Неоновый зеленый для доступных */
        }
        .feature-item.unavailable {
            color: #718096; /* Серый для недоступных */
        }
        .feature-item.unavailable .icon {
            color: #FF0000; /* Ярко-красный для недоступных */
        }
        .locked-content {
            filter: blur(2px); /* Размытие для заблокированного контента */
            pointer-events: none; /* Отключаем взаимодействие */
            user-select: none; /* Отключаем выделение текста */
        }
        .lock-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6); /* Более темный оверлей */
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            border-radius: 1rem;
            z-index: 10;
        }
        /* Нижняя навигация */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #0A0A14; /* Еще темнее синий фон для навигации */
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 0.5rem 0;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.5); /* Более темная тень */
            border-top-left-radius: 1rem;
            border-top-right-radius: 1rem;
            z-index: 100;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #CBD5E1;
            font-size: 0.75rem;
            font-weight: 500;
            padding: 0.5rem;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        .nav-item.active {
            color: #00FFFF; /* Неоновый синий для активных иконок/текста */
        }
        .nav-item:hover {
            color: #00FFFF; /* Неоновый синий при наведении */
        }
        .nav-item .nav-icon-circle {
            background-color: #1A1A2E; /* Темно-синий фон круга */
            border-radius: 50%;
            width: 48px; /* Размер круга */
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.25rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        .nav-item.active .nav-icon-circle {
            background-image: linear-gradient(to right, #4A00E0 0%, #00FFFF 100%); /* Градиент для активной кнопки */
            box-shadow: 0 2px 10px rgba(0, 255, 255, 0.5);
        }
        .nav-item .nav-icon {
            font-size: 1.5rem;
            color: #E2E8F0; /* Цвет иконки внутри круга */
            transition: color 0.3s ease;
        }
        .nav-item.active .nav-icon {
            color: white; /* Белый цвет иконки для активной кнопки */
        }
        /* Стили для логотипа */
        .app-logo {
            width: 100px; /* Размер логотипа */
            height: 100px;
            margin: 0 auto 1.5rem;
            display: block;
            /* Неоновое свечение */
            filter: drop-shadow(0 0 8px #00FFFF) drop-shadow(0 0 8px #FF00FF);
        }
        /* Временно скрываем логотип */
        .app-logo-hidden {
            display: none;
        }
        /* Стили для модального окна загрузки */
        .loading-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8); /* Полупрозрачный темный фон */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .loading-modal.active {
            opacity: 1;
            visibility: visible;
        }
        .loading-modal-content {
            background-color: #1A1A2E; /* Темно-синий фон */
            border-radius: 1rem;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5); /* Неоновое свечение */
            transform: scale(0.8);
            opacity: 0;
            animation: scaleIn 0.3s forwards;
        }
        @keyframes scaleIn {
            to { transform: scale(1); opacity: 1; }
        }
        .loading-text {
            font-size: 1.2rem;
            font-weight: 600;
            color: #00FFFF; /* Неоновый синий */
            margin-top: 1rem;
        }
        .loading-spinner-modal {
            border: 6px solid #3A3A4A;
            border-top: 6px solid #00FFFF; /* Неоновый синий */
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Логотип приложения (временно скрыт) -->
        <img src="logo.png" alt="Логотип CryptoVision AI Bot" class="app-logo app-logo-hidden">
        <h1 class="text-2xl font-bold text-center mb-6">CryptoVision - AI бот</h1>


        <!-- Analysis Page (Main App) -->
        <div id="analysisPage" class="page active">
            <h2 class="text-xl font-bold text-center mb-4">Посмотрите на ваш первый индивидуальный AI анализ графика:</h2>

            <div class="analysis-section-card mb-4">
                <label for="chartImageUpload" class="block text-sm font-medium mb-2 text-gray-300">Загрузите изображение графика:</label>
                <div class="image-upload-area" id="imageUploadArea">
                    <input type="file" id="chartImageUpload" accept="image/*" class="hidden">
                    <p class="text-gray-400">Нажмите или перетащите файл сюда</p>
                    <img id="imagePreview" class="image-preview mx-auto" src="#" alt="Предварительный просмотр графика">
                </div>
            </div>

            <button id="getAnalysisBtn" class="btn-primary w-full flex items-center justify-center mb-6">
                <span id="buttonText">Получить анализ</span>
                <div id="loadingSpinner" class="loading-spinner hidden ml-3"></div>
            </button>

            <div id="analysisResult" class="hidden">
                <!-- Key Insights Section -->
                <div class="analysis-section-card">
                    <h2>Ключевые Инсайты</h2>
                    <div class="key-insight-grid mb-4">
                        <div class="insight-item">
                            <span class="icon">📈</span>
                            <span>Тренд</span>
                            <span class="value" id="outputTrend">Бычий</span>
                        </div>
                        <div class="insight-item">
                            <span class="icon">📊</span>
                            <span>Волатильность</span>
                            <span class="value" id="outputVolatility">Средняя</span>
                        </div>
                        <div class="insight-item">
                            <span>Объем</span>
                            <span class="value" id="outputVolume">Высокий</span>
                        </div>
                        <div class="insight-item">
                            <span>Настроение рынка</span>
                            <span class="value" id="outputSentiment">Нейтральное</span>
                        </div>
                    </div>
                    <div class="space-y-2 text-gray-300">
                        <p class="analysis-item"><span class="text-blue-600">Действие:</span> <span id="outputAction" class="font-bold"></span></p>
                        <p class="analysis-item"><span class="text-blue-600">Цена входа:</span> <span id="outputEntryPrice"></span></p>
                        <p class="analysis-item"><span class="text-blue-600">Целевая цена:</span> <span id="outputTargetPrice"></span></p>
                        <p class="analysis-item"><span class="text-blue-600">Стоп-лосс:</span> <span id="outputStopLoss"></span></p>
                        <p class="analysis-item"><span class="text-blue-600">Тейк-профит:</span> <span id="outputTakeProfit"></span></p>
                    </div>
                </div>

                <!-- Game Plan Section -->
                <div class="analysis-section-card">
                    <h2>План Действий</h2>
                    <p class="game-plan-text" id="outputGamePlan">
                        Биткойн в настоящее время торгуется около $98,218 и демонстрирует сильный бычий импульс с высоким объемом, что указывает на растущий интерес. Мой торговый план состоит в том, чтобы войти в длинную позицию около $97,500, установить стоп-лосс чуть ниже недавней поддержки на уровне $95,000 и стремиться к цели в $105,000, что соответствует предыдущим уровням сопротивления. (демо)
                    </p>
                </div>

                <!-- Detailed Analysis Section (Locked for basic plan) -->
                <div class="analysis-section-card relative">
                    <h2>Детальный Анализ</h2>
                    <ul class="detailed-analysis-list locked-content">
                        <li>
                            <span class="number">1</span>
                            <span class="text-content" id="detailedAnalysis1">Внутридневная волатильность</span>
                            <span class="lock-icon">🔒</span>
                        </li>
                        <li>
                            <span class="number">2</span>
                            <span class="text-content" id="detailedAnalysis2">Всплески объема во время разворотов</span>
                            <span class="lock-icon">🔒</span>
                        </li>
                        <li>
                            <span class="number">3</span>
                            <span class="text-content" id="detailedAnalysis3">Отсутствие всеобъемлющего тренда</span>
                            <span class="lock-icon">🔒</span>
                        </li>
                        <li>
                            <span class="number">4</span>
                            <span class="text-content" id="detailedAnalysis4">Доминирование разворотных свечей</span>
                            <span class="lock-icon">🔒</span>
                        </li>
                        <li>
                            <span class="number">5</span>
                            <span class="text-content" id="detailedAnalysis5">Поддержка и сопротивление</span>
                            <span class="lock-icon">🔒</span>
                        </li>
                    </ul>
                    <div class="lock-overlay" id="detailedAnalysisLockOverlay">
                        <span class="text-2xl">Доступно в Премиум плане 🔒</span>
                    </div>
                </div>
            </div>

            <div id="errorMessage" class="hidden bg-red-800 border border-red-600 text-red-200 px-4 py-3 rounded-md mt-4" role="alert">
                <strong class="font-bold">Ошибка!</strong>
                <span class="block sm:inline" id="errorText"></span>
            </div>
        </div>

        <!-- Payment Page (Now includes subscription plans) -->
        <div id="paymentPage" class="page">
            <h2 class="text-xl font-semibold text-center mb-4">Ваш План и Подписки</h2>
            <div class="payment-info card">
                <p class="mb-4">Для оплаты подписок мы используем Telegram Stars.</p>
                <!-- Баланс удален -->
            </div>

            <h2 class="text-xl font-semibold text-center mt-6 mb-4">Наши Подписки</h2>
            <div class="subscription-plan">
                <h3>Базовый план</h3>
                <p>Доступ к базовому анализу.</p>
                <p class="font-bold text-lg mt-2">Бесплатно</p>
            </div>
            <div class="subscription-plan">
                <h3>Премиум план</h3>
                <p>Полный доступ к AI-анализу, расширенным инструментам и эксклюзивным сигналам.</p>
                <p class="font-bold text-lg mt-2">9.99 Stars/месяц</p>
                <button class="btn-primary w-full mt-3" onclick="requestSubscriptionPayment(999); playClickSound()">Подписаться</button>
            </div>
            <div class="subscription-plan">
                <h3>VIP план</h3>
                <p>Все возможности Премиум плана плюс персональные консультации и ранний доступ к новым функциям.</p>
                <p class="font-bold text-lg mt-2">29.99 Stars/месяц</p>
                <button class="btn-primary w-full mt-3" onclick="requestSubscriptionPayment(2999); playClickSound()">Подписаться</button>
            </div>
        </div>

        <!-- Instruction Modal -->
        <div id="instructionModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden">
            <div class="bg-gray-800 rounded-lg p-6 max-w-sm w-full relative">
                <h2 class="text-xl font-bold text-white mb-4 text-center">Инструкция</h2>
                <p class="text-gray-300 mb-4">
                    1. Загрузите скриншот графика, который вы хотите проанализировать.<br>
                    2. Нажмите "Получить анализ".<br>
                    3. AI предоставит вам ключевые инсайты и план действий.<br>
                    4. Для детального анализа и расширенных функций рассмотрите Премиум или VIP план.
                </p>
                <button class="btn-primary w-full" onclick="hideInstructionModal(); playClickSound()">Понятно</button>
            </div>
        </div>

    </div>

    <!-- Модальное окно загрузки -->
    <div id="loadingModal" class="loading-modal">
        <div class="loading-modal-content">
            <div class="loading-spinner-modal"></div>
            <p class="loading-text">AI анализирует график...</p>
        </div>
    </div>

    <!-- Нижняя навигация -->
    <div class="bottom-nav">
        <div class="nav-item active" data-page="analysisPage" onclick="showPage('analysisPage'); playClickSound(); activateNav(this)">
            <div class="nav-icon-circle">
                <span class="nav-icon">📈</span>
            </div>
            <span>Анализ</span>
        </div>
        <div class="nav-item" data-page="paymentPage" onclick="showPage('paymentPage'); playClickSound(); activateNav(this)">
            <div class="nav-icon-circle">
                <span class="nav-icon">⭐</span> <!-- Иконка звезды для оплаты/подписок -->
            </div>
            <span>Подписка</span>
        </div>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        // Получаем ссылки на элементы DOM
        const chartImageUpload = document.getElementById('chartImageUpload');
        const imageUploadArea = document.getElementById('imageUploadArea');
        const imagePreview = document.getElementById('imagePreview');
        const getAnalysisBtn = document.getElementById('getAnalysisBtn');
        const buttonText = document.getElementById('buttonText');
        const loadingSpinner = document.getElementById('loadingSpinner'); // Этот спиннер теперь не используется на кнопке
        const analysisResult = document.getElementById('analysisResult');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');

        // Элементы вывода анализа
        const outputAction = document.getElementById('outputAction');
        const outputEntryPrice = document.getElementById('outputEntryPrice');
        const outputTargetPrice = document.getElementById('outputTargetPrice');
        const outputStopLoss = document.getElementById('outputStopLoss');
        const outputTakeProfit = document.getElementById('outputTakeProfit');
        const outputTrend = document.getElementById('outputTrend');
        const outputVolatility = document.getElementById('outputVolatility');
        const outputVolume = document.getElementById('outputVolume');
        const outputSentiment = document.getElementById('outputSentiment');
        const outputGamePlan = document.getElementById('outputGamePlan');
        const detailedAnalysis1 = document.getElementById('detailedAnalysis1');
        const detailedAnalysis2 = document.getElementById('detailedAnalysis2');
        const detailedAnalysis3 = document.getElementById('detailedAnalysis3');
        const detailedAnalysis4 = document.getElementById('detailedAnalysis4');
        const detailedAnalysis5 = document.getElementById('detailedAnalysis5');
        const detailedAnalysisLockOverlay = document.getElementById('detailedAnalysisLockOverlay');


        // Элементы страниц и модальных окон
        const analysisPage = document.getElementById('analysisPage');
        const paymentPage = document.getElementById('paymentPage');
        const instructionModal = document.getElementById('instructionModal');
        const loadingModal = document.getElementById('loadingModal'); // Новое модальное окно загрузки


        // Кнопки пополнения Stars и баланс
        const userStarsBalance = document.getElementById('userStarsBalance'); // Этот элемент теперь не используется

        const navItems = document.querySelectorAll('.nav-item');

        let uploadedImageBase64 = null; // Для хранения base64 изображения

        // Инициализация Telegram Web App
        if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand(); // Разворачиваем мини-приложение на весь экран для лучшего UX
        } else {
            console.warn('Telegram Web App API not available. Running in standalone mode. Real payments will not work.');
        }

        // --- Звуковые эффекты ---
        const synth = new Tone.Synth().toDestination();

        function playClickSound() {
            if (Tone.context.state !== 'running') {
                Tone.context.resume();
            }
            synth.triggerAttackRelease('C4', '8n'); // Короткий клик
        }

        function playSuccessSound() {
            if (Tone.context.state !== 'running') {
                Tone.context.resume();
            }
            const now = Tone.context.currentTime;
            synth.triggerAttackRelease('C4', '8n', now);
            synth.triggerAttackRelease('E4', '8n', now + 0.1);
            synth.triggerAttackRelease('G4', '8n', now + 0.2); // Мажорный аккорд
        }

        function playErrorSound() {
            if (Tone.context.state !== 'running') {
                Tone.context.resume();
            }
            synth.triggerAttackRelease('C3', '8n', Tone.context.currentTime, 0.5);
            synth.triggerAttackRelease('B2', '8n', Tone.context.currentTime + 0.1, 0.5); // Диссонирующий звук
        }
        // --- Конец звуковых эффектов ---

        // Функция для переключения страниц
        function showPage(pageId) {
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            // Прокручиваем страницу вверх при смене
            window.scrollTo(0, 0);
        }

        // Функция для активации элемента нижней навигации
        function activateNav(element) {
            navItems.forEach(item => item.classList.remove('active'));
            element.classList.add('active');
        }

        // Функция для показа модального окна инструкции
        function showInstructionModal() {
            instructionModal.classList.remove('hidden');
            playClickSound(); // Звук при открытии модалки
        }

        // Функция для скрытия модального окна инструкции
        function hideInstructionModal() {
            instructionModal.classList.add('hidden');
            playClickSound(); // Звук при закрытии модалки
        }

        // Функции для управления модальным окном загрузки
        function showLoadingModal() {
            loadingModal.classList.add('active');
        }

        function hideLoadingModal() {
            loadingModal.classList.remove('active');
        }


        // Обработчик клика по области загрузки изображения
        imageUploadArea.addEventListener('click', () => {
            chartImageUpload.click();
            playClickSound();
        });

        // Обработчик изменения файла в input
        chartImageUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    imagePreview.style.display = 'block';
                    uploadedImageBase64 = e.target.result.split(',')[1]; // Сохраняем только base64 часть
                };
                reader.readAsDataURL(file);
                playClickSound(); // Звук при выборе файла
            } else {
                imagePreview.src = '#';
                imagePreview.style.display = 'none';
                uploadedImageBase64 = null;
            }
        });

        // Обработчик события для кнопки анализа
        getAnalysisBtn.addEventListener('click', async () => {
            if (!uploadedImageBase64) {
                showErrorMessage('Пожалуйста, загрузите изображение графика для анализа.');
                playErrorSound(); // Звук ошибки
                return;
            }

            // Показываем модальное окно загрузки
            showLoadingModal();
            playClickSound(); // Звук при нажатии кнопки

            hideErrorMessage();
            hideAnalysisResult();

            try {
                // Имитация задержки для демонстрации загрузки
                await new Promise(resolve => setTimeout(resolve, 5000)); // Задержка 5 секунд

                // Заглушка для функционала
                const dummyAnalysisData = {
                    action: Math.random() < 0.5 ? 'КУПИТЬ' : 'ПРОДАТЬ', // Случайное действие
                    entryPrice: '777',
                    targetPrice: '777',
                    stopLoss: '777',
                    takeProfit: '777',
                    trend: 'Бычий',
                    volatility: 'Средняя',
                    volume: 'Высокий',
                    sentiment: 'Нейтральное',
                    gamePlan: 'Биткойн в настоящее время торгуется около $98,218 и демонстрирует сильный бычий импульс с высоким объемом, что указывает на растущий интерес. Мой торговый план состоит в том, чтобы войти в длинную позицию около $97,500, установить стоп-лосс чуть ниже недавней поддержки на уровне $95,000 и стремиться к цели в $105,000, что соответствует предыдущим уровням сопротивления. (демо)',
                    detailedAnalysis: [
                        'Внутридневная волатильность',
                        'Всплески объема во время разворотов',
                        'Отсутствие всеобъемлющего тренда',
                        'Доминирование разворотных свечей',
                        'Поддержка и сопротивление'
                    ],
                    planLevel: 'basic' // 'basic', 'premium', 'vip' - для демонстрации блокировки
                };

                // Обновляем UI с заглушечными данными
                outputAction.textContent = dummyAnalysisData.action;
                outputEntryPrice.textContent = dummyAnalysisData.entryPrice;
                outputTargetPrice.textContent = dummyAnalysisData.targetPrice;
                outputStopLoss.textContent = dummyAnalysisData.stopLoss;
                outputTakeProfit.textContent = dummyAnalysisData.takeProfit;
                outputTrend.textContent = dummyAnalysisData.trend;
                outputVolatility.textContent = dummyAnalysisData.volatility;
                outputVolume.textContent = dummyAnalysisData.volume;
                outputSentiment.textContent = dummyAnalysisData.sentiment;
                outputGamePlan.textContent = dummyAnalysisData.gamePlan;
                detailedAnalysis1.textContent = dummyAnalysisData.detailedAnalysis[0];
                detailedAnalysis2.textContent = dummyAnalysisData.detailedAnalysis[1];
                detailedAnalysis3.textContent = dummyAnalysisData.detailedAnalysis[2];
                detailedAnalysis4.textContent = dummyAnalysisData.detailedAnalysis[3];
                detailedAnalysis5.textContent = dummyAnalysisData.detailedAnalysis[4];


                // Устанавливаем цвет для действия
                if (dummyAnalysisData.action === 'КУПИТЬ') {
                    outputAction.className = 'font-bold text-green-600';
                } else if (dummyAnalysisData.action === 'ПРОДАТЬ') {
                    outputAction.className = 'font-bold text-red-600';
                } else {
                    outputAction.className = 'font-bold text-gray-400';
                }

                // Управление блокировкой детального анализа
                if (dummyAnalysisData.planLevel === 'basic') {
                    detailedAnalysisLockOverlay.classList.remove('hidden');
                } else {
                    detailedAnalysisLockOverlay.classList.add('hidden');
                }

                showAnalysisResult();
                playSuccessSound(); // Звук успеха после анализа

                // В будущем здесь будет реальный вызов AI для анализа изображения:
                /*
                const prompt = "Проанализируйте этот график и предоставьте торговые рекомендации (КУПИТЬ/ПРОДАТЬ/ДЕРЖАТЬ), цену входа, целевую цену, стоп-лосс, тейк-профит, краткий технический анализ и краткий новостной анализ. Форматируйте ответ как JSON объект.";
                const chatHistory = [];
                const payload = {
                    contents: [
                        {
                            role: "user",
                            parts: [
                                { text: prompt },
                                {
                                    inlineData: {
                                        mimeType: "image/jpeg", // Или "image/png" в зависимости от загруженного
                                        data: uploadedImageBase64
                                    }
                                }
                            ]
                        }
                    ],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: { // Определите вашу схему здесь
                            type: "OBJECT",
                            properties: {
                                "action": { "type": "STRING" },
                                "entryPrice": { "type": "STRING" },
                                "targetPrice": { "type": "STRING" },
                                "stopLoss": { "type": "STRING" },
                                "takeProfit": { "type": "STRING" },
                                "technicalAnalysis": { "type": "STRING" },
                                "newsAnalysis": { "type": "STRING" }
                            }
                        }
                    }
                };

                const apiKey = ""; // API ключ будет предоставлен средой Canvas
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                // Обработка result и обновление UI
                */

            } catch (error) {
                console.error('Ошибка при получении анализа:', error);
                showErrorMessage('Произошла ошибка при получении анализа. Пожалуйста, проверьте ваше интернет-соединение или попробуйте позже.');
                playErrorSound(); // Звук ошибки
            } finally {
                hideLoadingModal(); // Скрываем модальное окно загрузки
            }
        });

        // Функция для запроса платежа Stars за подписку
        function requestSubscriptionPayment(starsAmount) {
            // В реальном приложении здесь будет логика для создания инвойса на сервере бота
            // и получения invoice_url или invoice_payload
            const invoicePayload = `subscription_plan_${starsAmount}`; // Пример payload

            if (Telegram.WebApp && Telegram.WebApp.requestPayment) {
                Telegram.WebApp.requestPayment({
                    amount: starsAmount, // Сумма в Stars (целые числа)
                    asset: 'stars', // Всегда 'stars' для Telegram Stars
                    payload: invoicePayload
                }, (status) => {
                    if (status.status === 'succeeded') {
                        // updateStarsBalance(starsAmount); // Демо-обновление баланса (удалено)
                        Telegram.WebApp.showAlert(`Подписка на ${starsAmount / 100} Stars успешно оплачена!`);
                        playSuccessSound();
                    } else {
                        Telegram.WebApp.showAlert(`Ошибка оплаты или отмена: ${status.status}`);
                        playErrorSound();
                    }
                });
            } else {
                console.warn(`Telegram Web App API not available. Cannot request payment for ${starsAmount / 100} Stars.`);
                Telegram.WebApp.showAlert(`Демо: Запрос платежа на ${starsAmount / 100} Stars. В реальном приложении откроется платежный интерфейс Telegram Stars.`);
                playErrorSound();
            }
        }

        // Демо-функция для обновления баланса Stars (удалена, так как баланс не отображается)
        /*
        function updateStarsBalance(amount) {
            let currentBalance = parseFloat(userStarsBalance.textContent.replace(' Stars', ''));
            currentBalance += amount / 100; // Делим на 100, так как в UI отображаем 9.99, а в API целые числа
            userStarsBalance.textContent = `${currentBalance.toFixed(2)} Stars`;
        }
        */

        // Функция для показа/скрытия спиннера загрузки (старая, теперь используется showLoadingModal/hideLoadingModal)
        function showLoading(isLoading) {
            // Эта функция теперь не используется для управления спиннером на кнопке,
            // но может быть использована для изменения текста кнопки
            if (isLoading) {
                buttonText.textContent = 'Загрузка...';
                getAnalysisBtn.disabled = true;
            } else {
                buttonText.textContent = 'Получить анализ';
                getAnalysisBtn.disabled = false;
            }
        }

        // Функция для показа секции с результатами анализа
        function showAnalysisResult() {
            analysisResult.classList.remove('hidden');
        }

        // Функция для скрытия секции с результатами анализа
        function hideAnalysisResult() {
            analysisResult.classList.add('hidden');
        }

        // Функция для показа сообщения об ошибке
        function showErrorMessage(message) {
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        // Функция для скрытия сообщения об ошибке
        function hideErrorMessage() {
            errorMessage.classList.add('hidden');
        }

    </script>
</body>
</html>
